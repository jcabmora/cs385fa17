<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>On your own &#8212; CS385 Cloud Systems Architecture  documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link href="https://fonts.googleapis.com/css?family=Lusitana|Inconsolata|Roboto" rel="stylesheet">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          CS385 Cloud Systems Architecture</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../syllabus.html">CS385 Cloud Systems Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab01/lab01.html">Lab No. 01: Deploying an Application to Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab02.html">Lab No. 02: Scaling</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">On your own</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../../_sources/labs/lab02/loadbancer.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <p>Execute the following command to run the REST API server in the background:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">nohup</span> <span class="n">sudo</span> <span class="n">FLASK_APP</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">restserver</span><span class="o">/</span><span class="n">restserver</span><span class="o">.</span><span class="n">py</span> <span class="n">flask</span> <span class="n">run</span> <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span> <span class="o">&amp;</span>
</pre></div>
</div>
</div></blockquote>
<p>You can now close the SSH session and the restserver will keep running in the background. Be aware that this does not mean that the REST server will autostart if you stop/start the instance.</p>
<p>Create another instance based on the “lab02-restserver” image. Name this instance “restserver-1”, and make sure that you enable HTTP/HTTPS traffic.</p>
<p>Start the restserver in “restserver-1” in the background and make sure that it works (use the Internal IP Address for your test).</p>
<p>At this point we have two instances running with the restserver. However, we need to add a load balancer in front of them in order to distribute the demand between the instances.</p>
<p>We will use nginx for this purpose. Create another microinstance (TODO insert specs here), and SSH into it.  Name this instance “loadbalancer-0”.</p>
<p>SSH into “loadbalancer-0” and execute the following commands to install nginx and its software dependencies:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">nginx</span>
</pre></div>
</div>
</div></blockquote>
<p>We now need to configure nginx to serve incoming requests to <code class="docutils literal"><span class="pre">/fibonacci</span></code> and forward them to the <code class="docutils literal"><span class="pre">restserver</span></code> nodes in a round robin fashion.</p>
<p>We need to edit the configuration file located under: <code class="docutils literal"><span class="pre">/etc/nginx/sites-available/default</span></code>.</p>
<p>Make sure that before making any changes to that file you make a backup</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">default</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">backup</span>
</pre></div>
</div>
</div></blockquote>
<p>Notice how this file has a json-like format.  To enable load balancing, we need to use the <code class="docutils literal"><span class="pre">upstream</span></code> directive.  Add this to the file</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">upstream</span> <span class="n">fibonacci</span> <span class="p">{</span>
<span class="n">server</span> <span class="o">&lt;</span><span class="n">RESTSERVER</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">INTERNAL</span><span class="o">-</span><span class="n">IP</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">server</span> <span class="o">&lt;</span><span class="n">RESTSERVER</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">INTERNAL</span><span class="o">-</span><span class="n">IP</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>we also need to modify the <code class="docutils literal"><span class="pre">location</span></code> element from the <code class="docutils literal"><span class="pre">server</span></code> directive to proxy requests to the <code class="docutils literal"><span class="pre">fibonacci</span></code> upstream group that we just added:</p>
<blockquote>
<div><dl class="docutils">
<dt>location / {</dt>
<dd>proxy_pass <a class="reference external" href="http://fibonacci">http://fibonacci</a>;</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>After this changes, your file should look like the following example (the internal IP address most likely be different, of course)</p>
<blockquote>
<div>TODO: insert default.conf</div></blockquote>
<p>Once you have finished editing the nginx configuration, we need to reload it.  Run the following command:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">nginx</span> <span class="n">reload</span>
</pre></div>
</div>
</div></blockquote>
<p>If you encounter any errors, it is almost certain that there is a problem with your configuration file.  You can get valuable troubleshooting information by running this command:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">nginx</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</div></blockquote>
<p>Once you have completed the configuration of the load balancer, we can test it by using the following curl command, from any computer:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">LOADBALANCER_IP_ADDRESS</span><span class="o">&gt;/</span><span class="n">fibonacci</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;{&quot;fibonacci_number&quot;: 20}&#39;</span>
</pre></div>
</div>
</div></blockquote>
<p>You should get a response.</p>
<p>Our restserver includes an <code class="docutils literal"><span class="pre">status</span></code> endpoint that lets us see the size of an internal cache that uses to stored previously computed fibonacci numbers, and also the number of requests.  Run the following command several times:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">LOADBALANCER_IP_ADDRESS</span><span class="o">&gt;/</span><span class="n">status</span>
</pre></div>
</div>
</div></blockquote>
<p>Do you see different values? Explain why.</p>
<div class="section" id="on-your-own">
<h1>On your own<a class="headerlink" href="#on-your-own" title="Permalink to this headline">¶</a></h1>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>