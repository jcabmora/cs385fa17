<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Lab No. 04: Messaging (Publisher/Subscriber Pattern) &#8212; CS385 Cloud Systems Architecture  documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Lab No. 03: Automating Deployment with REST APIs" href="../lab03/lab03.html" />
<link href="https://fonts.googleapis.com/css?family=Lusitana|Inconsolata|Roboto" rel="stylesheet">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          CS385 Cloud Systems Architecture</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../syllabus.html">CS385 Cloud Systems Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab01/lab01.html">Lab No. 01: Deploying an Application to Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab02/lab02.html">Lab No. 02: Scaling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab03/lab03.html">Lab No. 03: Automating Deployment with REST APIs</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Lab No. 04: Messaging (Publisher/Subscriber Pattern)</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Lab No. 04: Messaging (Publisher/Subscriber Pattern)</a><ul>
<li><a class="reference internal" href="#building-a-dockerfile-apache-kafka">Building a Dockerfile: Apache Kafka</a></li>
<li><a class="reference internal" href="#dockerfile-optimization">Dockerfile Optimization</a></li>
<li><a class="reference internal" href="#interacting-with-apache-kafka">Interacting with Apache Kafka</a></li>
<li><a class="reference internal" href="#a-websockets-chat-application">A Websockets Chat application</a></li>
<li><a class="reference internal" href="#enhancing-the-websockets-application-to-use-a-message-broker">Enhancing the Websockets Application to use a Message Broker</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../lab03/lab03.html" title="Previous Chapter: Lab No. 03: Automating Deployment with REST APIs"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Lab No. 03: A...</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../../_sources/labs/lab04/lab04.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="lab-no-04-messaging-publisher-subscriber-pattern">
<h1>Lab No. 04: Messaging (Publisher/Subscriber Pattern)<a class="headerlink" href="#lab-no-04-messaging-publisher-subscriber-pattern" title="Permalink to this headline">¶</a></h1>
<p>In this lab we are going to go through several stages to deploy a Websockets based Chat application. The end goal is to deploy a scalable application by means of applying the publisher/subscriber architectural pattern.  All the application components will be built and run using Docker.</p>
<p>The detailed goals of this lab are:</p>
<ul class="simple">
<li>Practice creating and optimizing Dockerfiles</li>
<li>Learn how to install and run Apache Kafka</li>
<li>Learn the basics of producing and consuming messages from Apacke Kafka</li>
<li>Learn how to interact with Apache Kafka in a programmatic way with Python</li>
<li>Create a Websockets Chat application</li>
<li>Apply the publisher/subscriber pattern to enable horizontal scalability to the Websockets Chat Application</li>
</ul>
<div class="section" id="building-a-dockerfile-apache-kafka">
<h2>Building a Dockerfile: Apache Kafka<a class="headerlink" href="#building-a-dockerfile-apache-kafka" title="Permalink to this headline">¶</a></h2>
<p>We are going to use <a class="reference external" href="https://kafka.apache.org/">Apache Kafka</a> as a message broker.</p>
<ol class="arabic">
<li><p class="first">Create a new instance, with 1 vCPU, 3.75 GB RAM, Ubuntu 16.04 LTS with 10 GB. Check <em>Allow HTTP traffic</em> and <em>Allow HTTPS traffic</em>.  Name this instance <strong>docker-0</strong></p>
</li>
<li><p class="first">SSH into <strong>docker-0</strong> and install Docker and docker-compose</p>
<blockquote>
<div><pre class="literal-block">
&gt; sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
&gt; curl -fsSL <a class="reference external" href="https://download.docker.com/linux/ubuntu/gpg">https://download.docker.com/linux/ubuntu/gpg</a> | sudo apt-key add -
&gt; sudo add-apt-repository &quot;deb [arch=amd64] <a class="reference external" href="https://download.docker.com/linux/ubuntu">https://download.docker.com/linux/ubuntu</a> $(lsb_release -cs) stable&quot;
&gt; sudo apt-get update
&gt; sudo apt-get install -y docker-ce
&gt; sudo curl -L <a class="reference external" href="https://github.com/docker/compose/releases/download/1.17.1/docker-compose">https://github.com/docker/compose/releases/download/1.17.1/docker-compose</a>-<cite>uname -s</cite>-<cite>uname -m</cite> -o /usr/local/bin/docker-compose
&gt; sudo chmod +x /usr/local/bin/docker-compose
</pre>
</div></blockquote>
</li>
<li><p class="first">Test your installation</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="n">hello</span><span class="o">-</span><span class="n">world</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">We are going to run Kafka and Zookeeper in docker containers.  Create a directory called <code class="docutils literal"><span class="pre">kafka</span></code> in your home(<code class="docutils literal"><span class="pre">~</span></code>) directory, and change into it. Create a <code class="docutils literal"><span class="pre">Dockerfile</span></code> with the following content:</p>
<blockquote>
<div><pre class="literal-block">
FROM openjdk:8-jre

ENV KAFKA_VERSION 1.0.0
ENV KAFKA_SCALA_VERSION 2.11
ENV KAFKA_ARCH &quot;kafka_$KAFKA_SCALA_VERSION-$KAFKA_VERSION.tgz&quot;
ENV KAFKA_HOME /opt/kafka

WORKDIR /opt

RUN apt-get update
RUN apt-get install -y jq
RUN wget -O - $(wget -qO- https://www.apache.org/dyn/closer.cgi\?as_json\=1\&amp;path\=/kafka/$KAFKA_VERSION/$KAFKA_ARCH | jq --raw-output '.preferred')kafka/$KAFKA_VERSION/$KAFKA_ARCH | tar zxf -
RUN mv /opt/kafka_$KAFKA_SCALA_VERSION-$KAFKA_VERSION $KAFKA_HOME
RUN sed -i 's/zookeeper.connect=localhost:2181/zookeeper.connect=zookeeper:2181/g' /opt/kafka/config/server.properties
RUN sed -i 's/broker.id=0/broker.id=-1/g' /opt/kafka/config/server.properties

CMD [&quot;/opt/kafka/bin/kafka-server-start.sh&quot;, &quot;/opt/kafka/config/server.properties&quot;]
</pre>
</div></blockquote>
</li>
<li><p class="first">Build the docker image:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span> <span class="o">.</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Run the <code class="docutils literal"><span class="pre">docker</span> <span class="pre">images</span></code> command. Notice how you have entries for the image that was just built and for the base image:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">images</span>
<span class="n">REPOSITORY</span>          <span class="n">TAG</span>                 <span class="n">IMAGE</span> <span class="n">ID</span>            <span class="n">CREATED</span>             <span class="n">SIZE</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">latest</span>              <span class="mi">0</span><span class="n">d5561696173</span>        <span class="mi">35</span> <span class="n">seconds</span> <span class="n">ago</span>      <span class="mi">664</span> <span class="n">MB</span>
<span class="n">openjdk</span>             <span class="mi">8</span><span class="o">-</span><span class="n">jre</span>               <span class="mi">97</span><span class="n">c270c3cab0</span>        <span class="mi">2</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="mi">538</span> <span class="n">MB</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Verfiy the image layers by using the <code class="docutils literal"><span class="pre">docker</span> <span class="pre">history</span></code> command. You should get an output like this:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span>&gt; docker history kafka-cs385
IMAGE               CREATED              CREATED BY                                      SIZE                COMMENT
0d5561696173        About a minute ago   /bin/sh -c #(nop)  CMD [&quot;/opt/kafka/bin/ka...   0 B
4708edf77a2e        About a minute ago   /bin/sh -c sed -i &#39;s/broker.id=0/broker.id...   6.85 kB
0dfd12e9e45b        About a minute ago   /bin/sh -c sed -i &#39;s/zookeeper.connect=loc...   6.85 kB
496d69696442        About a minute ago   /bin/sh -c mv /opt/kafka_$KAFKA_SCALA_VERS...   53.8 MB
70c00ed2c3d4        About a minute ago   /bin/sh -c wget -O - $(wget -qO- https://w...   53.8 MB
21d5ee624a56        2 minutes ago        /bin/sh -c apt-get install -y jq                2.81 MB
3c3ab697f892        2 minutes ago        /bin/sh -c apt-get update                       15.8 MB
2704476162d5        2 minutes ago        /bin/sh -c #(nop) WORKDIR /opt                  0 B
2e51884a69fe        2 minutes ago        /bin/sh -c #(nop)  ENV KAFKA_HOME=/opt/kafka    0 B
54fd776cf0eb        2 minutes ago        /bin/sh -c #(nop)  ENV KAFKA_ARCH=kafka_2....   0 B
599bc7dca00f        2 minutes ago        /bin/sh -c #(nop)  ENV KAFKA_SCALA_VERSION...   0 B
a0a0efd8b3c7        2 minutes ago        /bin/sh -c #(nop)  ENV KAFKA_VERSION=1.0.0      0 B
97c270c3cab0        2 weeks ago          /bin/sh -c /var/lib/dpkg/info/ca-certifica...   394 kB
&lt;missing&gt;           2 weeks ago          /bin/sh -c set -ex;   if [ ! -d /usr/share...   404 MB
&lt;missing&gt;           2 weeks ago          /bin/sh -c #(nop)  ENV CA_CERTIFICATES_JAV...   0 B
&lt;missing&gt;           2 weeks ago          /bin/sh -c #(nop)  ENV JAVA_DEBIAN_VERSION...   0 B
&lt;missing&gt;           2 weeks ago          /bin/sh -c #(nop)  ENV JAVA_VERSION=8u151       0 B
&lt;missing&gt;           2 weeks ago          /bin/sh -c #(nop)  ENV JAVA_HOME=/docker-j...   0 B
&lt;missing&gt;           2 weeks ago          /bin/sh -c ln -svT &quot;/usr/lib/jvm/java-8-op...   33 B
&lt;missing&gt;           2 weeks ago          /bin/sh -c {   echo &#39;#!/bin/sh&#39;;   echo &#39;s...   87 B
&lt;missing&gt;           2 weeks ago          /bin/sh -c #(nop)  ENV LANG=C.UTF-8             0 B
&lt;missing&gt;           2 weeks ago          /bin/sh -c apt-get update &amp;&amp; apt-get insta...   2.05 MB
&lt;missing&gt;           2 weeks ago          /bin/sh -c set -ex;  if ! command -v gpg &gt;...   7.8 MB
&lt;missing&gt;           2 weeks ago          /bin/sh -c apt-get update &amp;&amp; apt-get insta...   23.8 MB
&lt;missing&gt;           2 weeks ago          /bin/sh -c #(nop)  CMD [&quot;bash&quot;]                 0 B
&lt;missing&gt;           2 weeks ago          /bin/sh -c #(nop) ADD file:a71e077a42995a6...   100 MB
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">In the previous command output, each line correspond to layers added during image builds. You can see that the last layers added correspond to the build steps from the Dockerfile we just built.  Compare the history of <code class="docutils literal"><span class="pre">kafka-cs385</span></code> with the history of <code class="docutils literal"><span class="pre">openjdk:8-jre</span></code>.  How many layers were added by our Dockerfile? How much bigger MB is <code class="docutils literal"><span class="pre">kafka-cs385</span></code> when compared to <code class="docutils literal"><span class="pre">openjdk:8-jre</span></code>?</p>
</li>
<li><p class="first">Before proceeding any further, we need to test that our image runs.  To do this, we first need to start a Zookeeper server.  To run zookeeper we are going to use the official <a class="reference external" href="https://hub.docker.com/_/zookeeper/">Apache Zookeeper Docker Image</a>. To run it, use this command:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">name</span> <span class="n">zookeeper</span> <span class="n">zookeeper</span><span class="p">:</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">11</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Now that Zookeeper is running we can start Kafka:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">link</span> <span class="n">zookeeper</span> <span class="o">--</span><span class="n">name</span> <span class="n">kafka</span> <span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Verify that both Kafka and Kookeeper are running by executing the <code class="docutils literal"><span class="pre">docker</span> <span class="pre">ps</span></code> command:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">ps</span>
<span class="n">CONTAINER</span> <span class="n">ID</span>        <span class="n">IMAGE</span>                <span class="n">COMMAND</span>                  <span class="n">CREATED</span>             <span class="n">STATUS</span>              <span class="n">PORTS</span>                          <span class="n">NAMES</span>
<span class="mi">6</span><span class="n">a76c10946f9</span>        <span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>          <span class="s2">&quot;/opt/kafka/bin/ka...&quot;</span>   <span class="mi">7</span> <span class="n">seconds</span> <span class="n">ago</span>       <span class="n">Up</span> <span class="mi">6</span> <span class="n">minutes</span>                                       <span class="n">kafka</span>
<span class="n">c53269318237</span>        <span class="n">zookeeper</span><span class="p">:</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">11</span>     <span class="s2">&quot;/docker-entrypoin...&quot;</span>   <span class="mi">4</span> <span class="n">hours</span> <span class="n">ago</span>         <span class="n">Up</span> <span class="mi">4</span> <span class="n">hours</span>          <span class="mi">2181</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mi">2888</span><span class="o">/</span><span class="n">tcp</span><span class="p">,</span> <span class="mi">3888</span><span class="o">/</span><span class="n">tcp</span>   <span class="n">zookeeper</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">To test Kafka, we are going to log into the container. To do this, we will use the <code class="docutils literal"><span class="pre">docker</span> <span class="pre">exec</span></code> command in <em>interactive</em> mode:</p>
<blockquote>
<div><pre class="literal-block">
&gt; docker exec -it kafka bash
root&#64;6a76c10946f9:/opt#
</pre>
</div></blockquote>
</li>
<li><p class="first">Notice how your shell prompt changed, and it includes the container id as host name. You can now run commands that will be executed inside the container. We are going to do now several basic interactions with Kafka (refer to the <a class="reference external" href="https://kafka.apache.org/quickstart">Apache Kafka Quickstart</a> First create a topic:</p>
<blockquote>
<div><pre class="literal-block">
root&#64;6a76c10946f9:/opt# kafka/bin/kafka-topics.sh --create --zookeeper zookeeper:2181 --replication-factor 1 --partitions 1 --topic mytopic
Created topic &quot;mytopic&quot;.
</pre>
</div></blockquote>
</li>
<li><p class="first">Now we use the <strong>Kafka console producer</strong> to write some messages:</p>
<blockquote>
<div><pre class="literal-block">
root&#64;6a76c10946f9:/opt# kafka/bin/kafka-console-producer.sh --broker-list localhost:9092 --topic mytopic
</pre>
</div></blockquote>
</li>
<li><p class="first">Enter several lines of text and press <code class="kbd docutils literal"><span class="pre">Ctrl+C</span></code> to close the console producer. Now let’s read those messages using the console consumer:</p>
<pre class="literal-block">
root&#64;6a76c10946f9:/opt# kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic mytopic --from-beginning
</pre>
</li>
<li><p class="first">Notice how the messages that you created earlier are retrieved by the console consumer. Once all the messages are written to the terminal, press <code class="kbd docutils literal"><span class="pre">Ctrl+C</span></code> to terminate the console consumer.</p>
</li>
<li><p class="first">Exit the container (by using the exit command as you do with a normal SSH session). We now want to terminate the container by using the docker stop command:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">stop</span> <span class="n">kafka</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">If you run the <code class="docutils literal"><span class="pre">docker</span> <span class="pre">ps</span></code> command, the container is not shown as running anymore. Nevertheless, the container still exists and it can be restarted.  Compare the output of <code class="docutils literal"><span class="pre">docker</span> <span class="pre">ps</span></code> with the same command but using the <code class="docutils literal"><span class="pre">-a</span></code> option which shows all the containers.  If we want to remove a container completely, then we must use the <code class="docutils literal"><span class="pre">docker</span> <span class="pre">rm</span></code> command:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">rm</span> <span class="n">kafka</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="dockerfile-optimization">
<h2>Dockerfile Optimization<a class="headerlink" href="#dockerfile-optimization" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">The Dockerfile that we used works, but it generates an image that is rather big in size. We can reduce the size of the image by merging several instructions together. Merge all the <strong>RUN</strong> instructions into a single isntruction.  How much space do you save by doing this? Provide an updated Dockerfile in your report. Build this dockerfile and tag is as <code class="docutils literal"><span class="pre">kafka-cs385:consolidated_run</span></code>:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span><span class="p">:</span><span class="n">consolidated_run</span> <span class="o">.</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">After you successfully build this new image, run it as we did before with the <code class="docutils literal"><span class="pre">kafka-cs385</span></code> image, and make sure that Kafka is working and you can create topics, produce messages and retrieve them.</p>
</li>
<li><p class="first">We can also reduce the amount of used space by removing the cache of installation utilities. Add a command to the <strong>RUN</strong> instruction to remove the <code class="docutils literal"><span class="pre">apt</span></code> cache.  Hint: The <a class="reference external" href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#run">Dockerfile best practices</a> reference has very valuable information that can help you. Build this image and tag it as <code class="docutils literal"><span class="pre">kafka-cs385:nocache</span></code></p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span><span class="p">:</span><span class="n">nocache</span> <span class="o">.</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">As we did before, make sure that your image works and you can interact with topics.</p>
</li>
<li><p class="first">We can further reduce the size of our Kafka image by using a smaller base image.  The <a class="reference external" href="https://hub.docker.com/_/openjdk/">OpenJDK official docker repository</a> has many images that can be used. Typically, the <em>slim</em> versions are debian based images of much smaller size. Update the Dockerfile to use a <em>slim</em> base image. Note that you will need not only to update the base image, but you will probably need to install utilities that are no longer include in the base image and are needed to complete the installation of kafka. Build this image and tag is as <code class="docutils literal"><span class="pre">kafka-cs385:slim</span></code></p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span><span class="p">:</span><span class="n">slim</span> <span class="o">.</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">As before, make sure that your image works and you can interact with topics.</p>
</li>
<li><p class="first">After performing the previous optimizations, you can compare the sizes of the resulting images (your image sizes might differ a little bit, but should be very close to these values)</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">images</span>
<span class="n">REPOSITORY</span>          <span class="n">TAG</span>                 <span class="n">IMAGE</span> <span class="n">ID</span>            <span class="n">CREATED</span>             <span class="n">SIZE</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">slim</span>                <span class="mi">0</span><span class="n">c76aa21f306</span>        <span class="mi">5</span> <span class="n">minutes</span> <span class="n">ago</span>       <span class="mi">263</span> <span class="n">MB</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">nocache</span>             <span class="n">eda22e7be277</span>        <span class="mi">12</span> <span class="n">minutes</span> <span class="n">ago</span>      <span class="mi">594</span> <span class="n">MB</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">consolidated_run</span>    <span class="n">e9b0d0b69019</span>        <span class="mi">23</span> <span class="n">minutes</span> <span class="n">ago</span>      <span class="mi">610</span> <span class="n">MB</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">latest</span>              <span class="mi">0</span><span class="n">d5561696173</span>        <span class="mi">30</span> <span class="n">minutes</span> <span class="n">ago</span>      <span class="mi">664</span> <span class="n">MB</span>
<span class="n">openjdk</span>             <span class="mi">8</span><span class="o">-</span><span class="n">jre</span>               <span class="mi">97</span><span class="n">c270c3cab0</span>        <span class="mi">2</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="mi">538</span> <span class="n">MB</span>
<span class="n">openjdk</span>             <span class="mi">8</span><span class="o">-</span><span class="n">jre</span><span class="o">-</span><span class="n">slim</span>          <span class="mi">837969</span><span class="n">d6f968</span>        <span class="mi">2</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="mi">205</span> <span class="n">MB</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Optional: Instead of using an image based on debian, you can use an <em>alpine</em> base image to reduce the size of the image even more.  You will need to do some experimentation to figure out which utilities need to be installed to be able to install kafka, and also to run it.</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">images</span>
<span class="n">REPOSITORY</span>          <span class="n">TAG</span>                 <span class="n">IMAGE</span> <span class="n">ID</span>            <span class="n">CREATED</span>             <span class="n">SIZE</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">alpine</span>              <span class="mi">44</span><span class="n">ea7ee63d23</span>        <span class="mi">16</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="mi">144</span> <span class="n">MB</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">slim</span>                <span class="mi">0</span><span class="n">c76aa21f306</span>        <span class="mi">21</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="mi">263</span> <span class="n">MB</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">nocache</span>             <span class="n">eda22e7be277</span>        <span class="mi">21</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="mi">594</span> <span class="n">MB</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">consolidated_run</span>    <span class="n">e9b0d0b69019</span>        <span class="mi">22</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="mi">610</span> <span class="n">MB</span>
<span class="n">kafka</span><span class="o">-</span><span class="n">cs385</span>         <span class="n">latest</span>              <span class="mi">0</span><span class="n">d5561696173</span>        <span class="mi">22</span> <span class="n">hours</span> <span class="n">ago</span>        <span class="mi">664</span> <span class="n">MB</span>
<span class="n">zookeeper</span>           <span class="mf">3.4</span><span class="o">.</span><span class="mi">11</span>              <span class="mi">09</span><span class="n">fe1e7c8f0f</span>        <span class="mi">11</span> <span class="n">days</span> <span class="n">ago</span>         <span class="mi">146</span> <span class="n">MB</span>
<span class="n">openjdk</span>             <span class="mi">8</span><span class="o">-</span><span class="n">jre</span>               <span class="mi">97</span><span class="n">c270c3cab0</span>        <span class="mi">2</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="mi">538</span> <span class="n">MB</span>
<span class="n">openjdk</span>             <span class="mi">8</span><span class="o">-</span><span class="n">jre</span><span class="o">-</span><span class="n">alpine</span>        <span class="n">b36ec9de53a8</span>        <span class="mi">2</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="mf">81.4</span> <span class="n">MB</span>
<span class="n">openjdk</span>             <span class="mi">8</span><span class="o">-</span><span class="n">jre</span><span class="o">-</span><span class="n">slim</span>          <span class="mi">837969</span><span class="n">d6f968</span>        <span class="mi">2</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="mi">205</span> <span class="n">MB</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="interacting-with-apache-kafka">
<h2>Interacting with Apache Kafka<a class="headerlink" href="#interacting-with-apache-kafka" title="Permalink to this headline">¶</a></h2>
<p>In this section we are going to learn how to interact with Kafka programatically using the <a class="reference external" href="https://github.com/Parsely/pykafka">pykafka</a> python library.
We are going to create a simple app that exposes a REST API that receives messages and writes them to Kafka topics.  We are then going to create another app that consumes those messages.</p>
<ol class="arabic">
<li><p class="first">SSH into <strong>docker-0</strong>. Create a new directory called <code class="docutils literal"><span class="pre">kafkaclien</span></code> and change into it.</p>
</li>
<li><p class="first">Create a file called <code class="docutils literal"><span class="pre">app.py</span></code> with the following content:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">pykafka</span> <span class="k">import</span> <span class="n">KafkaClient</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">KafkaClient</span><span class="p">(</span><span class="n">zookeeper_hosts</span><span class="o">=</span><span class="s2">&quot;zookeeper&quot;</span><span class="p">)</span>

<span class="c1"># create topics</span>

<span class="n">topics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deliveries&#39;</span><span class="p">,</span> <span class="s1">&#39;updates&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">topics</span><span class="p">:</span>
    <span class="n">client</span><span class="o">.</span><span class="n">topics</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/kafka&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">write_message</span><span class="p">():</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">req_topic</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;topic&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">req_message</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">req_topic</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">topics</span><span class="p">:</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">topics</span><span class="p">[</span><span class="n">req_topic</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">topic</span><span class="o">.</span><span class="n">get_sync_producer</span><span class="p">(</span><span class="n">max_queued_messages</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">linger_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">producer</span><span class="p">:</span>
            <span class="n">producer</span><span class="o">.</span><span class="n">produce</span><span class="p">(</span><span class="n">req_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="s1">&#39;{&quot;msg&quot;: &quot;Success&quot;}&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="s1">&#39;{&quot;msg&quot;: &quot;Invalid Topic&quot;}&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Create a file called <code class="docutils literal"><span class="pre">requirements.txt</span></code> with the following content:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Flask</span><span class="o">==</span><span class="mf">0.12</span><span class="o">.</span><span class="mi">2</span>
<span class="n">pykafka</span><span class="o">==</span><span class="mf">2.6</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Create a <code class="docutils literal"><span class="pre">Dockerfile</span></code> with the following contents:</p>
<blockquote>
<div><pre class="literal-block">
FROM python:2.7-alpine3.6

COPY * /opt/kafkaclient/

WORKDIR /opt/kafkaclient

RUN apk add --no-cache g++     &amp;&amp; pip install -r requirements.txt

ENV FLASK_APP app.py

CMD [&quot;flask&quot;, &quot;run&quot;, &quot;--host=0.0.0.0&quot;, &quot;--port=5000&quot;]
</pre>
</div></blockquote>
</li>
<li><p class="first">Once all these files have been created, the directory tree of <code class="docutils literal"><span class="pre">kafkaclient</span></code> should look like this:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span>kafkaclient
   ├── app.py
   ├── Dockerfile
   └── requirements.txt
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Build the image:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">kafkaclient</span> <span class="o">.</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Start Zookeeper and Kafka  using the same instructions from the previous section (Use the most optimized Kafka image available)</p>
</li>
<li><p class="first">Start a  <em>kafkaclient</em> container, instructing docker to link both the <code class="docutils literal"><span class="pre">zookeeper</span></code> and the <code class="docutils literal"><span class="pre">kafka</span></code> containers, and to expose the container’s port 5000 in the host’s port 5000:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">link</span> <span class="n">kafka</span>  <span class="o">--</span><span class="n">link</span> <span class="n">zookeeper</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5000</span><span class="p">:</span><span class="mi">5000</span> <span class="o">--</span><span class="n">name</span> <span class="n">kafkaclient</span> <span class="n">kafkaclient</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">The application has two hard-coded topics (“deliveries” and “updates”), and only writes messages to those topics. To write a message, we will use the <code class="docutils literal"><span class="pre">POST</span> <span class="pre">/kafka</span></code> REST API endpoint:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-type: application/json&#39;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">kafka</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;{&quot;topic&quot;: &quot;deliveries&quot;, &quot;message&quot;: &quot;Chuck Norris just delivered you a roundhouse kick.&quot;}&#39;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Try writing different messages and writing to topics that are not <code class="docutils literal"><span class="pre">deliveries</span></code> or <code class="docutils literal"><span class="pre">updates</span></code>.</p>
</li>
<li><p class="first">Open another terminal, log into the <code class="docutils literal"><span class="pre">kafka</span></code> container and start a console consumer for the “deliveries” topic (we used the <code class="docutils literal"><span class="pre">kafka-console-consumer</span></code> back in the <strong>Building a Dockerfile: Apache Kafka</strong> section). Write some messages to the <code class="docutils literal"><span class="pre">deliveries</span></code> topic using the <code class="docutils literal"><span class="pre">POST</span> <span class="pre">/kafka</span></code> REST API and notice the effect on the console consumer.</p>
</li>
<li><p class="first">Exit out of the <code class="docutils literal"><span class="pre">kafka</span></code> container. We are now going to consume the messages programatically with Python.  Start a container based on the <code class="docutils literal"><span class="pre">kafkaclient</span></code> image, but this time we are going to start it in interactive mode instead of having the container running in the background:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">link</span> <span class="n">kafka</span> <span class="o">--</span><span class="n">link</span> <span class="n">zookeeper</span> <span class="o">--</span><span class="n">name</span> <span class="n">kafkaconsumer</span> <span class="n">kafkaclient</span> <span class="n">sh</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Once you are in the container, start an interactive python session and use the pykafka library to retrieve the messages</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">kafkaclient</span> <span class="c1"># python</span>
<span class="n">Python</span> <span class="mf">2.7</span><span class="o">.</span><span class="mi">14</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Nov</span>  <span class="mi">4</span> <span class="mi">2017</span><span class="p">,</span> <span class="mi">00</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">6.3</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux2</span>
<span class="n">Type</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="s2">&quot;copyright&quot;</span><span class="p">,</span> <span class="s2">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s2">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pykafka</span> <span class="k">import</span> <span class="n">KafkaClient</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">client</span> <span class="o">=</span> <span class="n">KafkaClient</span><span class="p">(</span><span class="n">zookeeper_hosts</span><span class="o">=</span><span class="s2">&quot;zookeeper&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">client</span><span class="o">.</span><span class="n">topics</span>
<span class="p">{</span><span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;bla&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;updates&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;deliveries&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">topics</span><span class="p">[</span><span class="s1">&#39;deliveries&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">topic</span><span class="o">.</span><span class="n">get_simple_consumer</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">consumer</span><span class="p">:</span>
<span class="o">...</span>     <span class="nb">print</span> <span class="n">message</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">value</span>
<span class="o">...</span>
<span class="mi">0</span> <span class="n">Chuck</span> <span class="n">Norris</span> <span class="n">just</span> <span class="n">delivered</span> <span class="n">you</span> <span class="n">a</span> <span class="n">roundhouse</span> <span class="n">kick</span><span class="o">.</span>
<span class="mi">1</span> <span class="n">blabla</span>
<span class="mi">2</span> <span class="n">foo</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Without closing the python interpreter, go back to the terminal that you used to call the <code class="docutils literal"><span class="pre">POST</span> <span class="pre">/kafka</span></code> REST API and write a few more messages. Notice the effect on the output in the python interpreter session that is consuming messages from kafka.</p>
</li>
</ol>
</div>
<div class="section" id="a-websockets-chat-application">
<h2>A Websockets Chat application<a class="headerlink" href="#a-websockets-chat-application" title="Permalink to this headline">¶</a></h2>
<p>In this section, we are going to create a very simple chat application (all source code is based in the examples provided by the <a class="reference external" href="https://github.com/miguelgrinberg/Flask-SocketIO">Flask-SocketIO</a> python library.)</p>
<ol class="arabic">
<li><p class="first">SSH into <strong>docker-0</strong>. Create a new directory called <code class="docutils literal"><span class="pre">chatserver</span></code> and change into it.</p>
</li>
<li><p class="first">Create a file called <code class="docutils literal"><span class="pre">app.py</span></code> with the following content:</p>
<blockquote>
<div><pre class="literal-block">
from flask import Flask, render_template, session, request
from flask_socketio import SocketIO, emit, join_room, leave_room, \
    close_room, rooms, disconnect

async_mode = None

app = Flask(__name__)
app.config['SECRET_KEY'] = 'secret!'
socketio = SocketIO(app, async_mode=async_mode)

&#64;app.route('/')
def index():
    return render_template('index.html', async_mode=socketio.async_mode)


&#64;socketio.on('echo_event', namespace='/test')
def test_message(message):
    session['receive_count'] = session.get('receive_count', 0) + 1
    emit('my_response',
         {'data': message['data'], 'count': session['receive_count']})


&#64;socketio.on('broadcast_event', namespace='/test')
def test_broadcast_message(message):
    session['receive_count'] = session.get('receive_count', 0) + 1
    emit('my_response',
         {'data': message['data'], 'count': session['receive_count']},
         broadcast=True)


&#64;socketio.on('disconnect_request', namespace='/test')
def disconnect_request():
    session['receive_count'] = session.get('receive_count', 0) + 1
    emit('my_response',
         {'data': 'Disconnected!', 'count': session['receive_count']})
    disconnect()


&#64;socketio.on('connect', namespace='/test')
def test_connect():
    emit('my_response', {'data': 'Connected', 'count': 0})


&#64;socketio.on('disconnect', namespace='/test')
def test_disconnect():
    print('Client disconnected', request.sid)


if __name__ == '__main__':
    socketio.run(app, debug=True)
</pre>
</div></blockquote>
</li>
<li><p class="first">Create a file called <code class="docutils literal"><span class="pre">requirements.txt</span></code> with the following content:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">eventlet</span><span class="o">==</span><span class="mf">0.21</span><span class="o">.</span><span class="mi">0</span>
<span class="n">Flask</span><span class="o">-</span><span class="n">SocketIO</span><span class="o">==</span><span class="mf">2.9</span><span class="o">.</span><span class="mi">2</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Create a directory within <code class="docutils literal"><span class="pre">chatserver</span></code> called <code class="docutils literal"><span class="pre">templates</span></code> and then create a file called <code class="docutils literal"><span class="pre">index.html</span></code> inside this directory, with the following content:</p>
<blockquote>
<div><pre class="literal-block">
&lt;!DOCTYPE HTML&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Chatty&lt;/title&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;//code.jquery.com/jquery-1.4.2.min.js&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;
        $(document).ready(function() {
            namespace = '/test';
            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);

            socket.on('connect', function() {
                socket.emit('my_event', {data: 'I\'m connected!'});
            });

            socket.on('my_response', function(msg) {
                $('#log').append('&lt;br&gt;' + $('&lt;div/&gt;').text('Received #' + msg.count + ': ' + msg.data).html());
            });

            // Form Handlers
            $('form#echo').submit(function(event) {
                socket.emit('echo_event', {data: $('#echo_data').val()});
                return false;
            });
            $('form#broadcast').submit(function(event) {
                socket.emit('broadcast_event', {data: $('#broadcast_data').val()});
                return false;
            });
            $('form#disconnect').submit(function(event) {
                socket.emit('disconnect_request');
                return false;
            });
        });
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Chatty&lt;/h1&gt;
    &lt;h2&gt;Send:&lt;/h2&gt;
    &lt;form id=&quot;echo&quot; method=&quot;POST&quot; action='#'&gt;
        &lt;input type=&quot;text&quot; name=&quot;echo_data&quot; id=&quot;echo_data&quot; placeholder=&quot;Message&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Echo&quot;&gt;
    &lt;/form&gt;
    &lt;form id=&quot;broadcast&quot; method=&quot;POST&quot; action='#'&gt;
        &lt;input type=&quot;text&quot; name=&quot;broadcast_data&quot; id=&quot;broadcast_data&quot; placeholder=&quot;Message&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Broadcast&quot;&gt;
    &lt;/form&gt;
    &lt;form id=&quot;disconnect&quot; method=&quot;POST&quot; action=&quot;#&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;Disconnect&quot;&gt;
    &lt;/form&gt;
    &lt;h2&gt;Received Messages:&lt;/h2&gt;
    &lt;div id=&quot;log&quot;&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div></blockquote>
</li>
<li><p class="first">Back in the <code class="docutils literal"><span class="pre">chatserver</span></code> directory, create a <code class="docutils literal"><span class="pre">Dockerfile</span></code> with the following contents:</p>
<blockquote>
<div><pre class="literal-block">
FROM python:2.7-alpine3.6

COPY . /opt/chatserver/

WORKDIR /opt/chatserver

RUN apk add --no-cache g++ \
    &amp;&amp; pip install -r requirements.txt

ENV FLASK_APP app.py

CMD [&quot;flask&quot;, &quot;run&quot;, &quot;--host=0.0.0.0&quot;, &quot;--port=5000&quot;]
</pre>
</div></blockquote>
</li>
<li><p class="first">Once all these files have been created, the directory tree of <code class="docutils literal"><span class="pre">chatserver</span></code> should look like this:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span>chatserver
   ├── app.py
   ├── Dockerfile
   ├── requirements.txt
   └── templates
       └── index.html
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Build the image and tag it as <code class="docutils literal"><span class="pre">chatserver</span></code>:</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">chatserver</span> <span class="o">.</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Next we want to test the chat application. We are goint to start a container named <em>test_chatserver</em> (<code class="docutils literal"><span class="pre">--name</span> <span class="pre">test_chatserver</span></code>) with the <em>chatserver</em> image we just built, exposing port 5000 of the container as port 80 on the host (<code class="docutils literal"><span class="pre">-p</span> <span class="pre">80:5000</span></code>). This container is going to run in <em>detached</em> mode (<code class="docutils literal"><span class="pre">-d</span></code>) and since are just testing we are going to instruct docker to remove the container once it is stopped (<code class="docutils literal"><span class="pre">--rm</span></code>)</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">p</span> <span class="mi">80</span><span class="p">:</span><span class="mi">5000</span>  <span class="o">--</span><span class="n">name</span> <span class="n">test_chatserver</span> <span class="n">chatserver</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Open a browser and browse to the External IP Address asigned to <strong>docker-0</strong>. You should see the app running. Experiment with the different options.  Open a second browser (use the incognito option so no session data is shared) and experiment with the broadcast option.</p>
</li>
</ol>
</div>
<div class="section" id="enhancing-the-websockets-application-to-use-a-message-broker">
<h2>Enhancing the Websockets Application to use a Message Broker<a class="headerlink" href="#enhancing-the-websockets-application-to-use-a-message-broker" title="Permalink to this headline">¶</a></h2>
<p>In this section you will work on your own.  The objective is to enhance the Chat application.  A problem that the application currently has is that it is hard to scale.  Think about how you would scale the application horizontally, and how would you be able to broadcast a message.  By using a message broker, we can write the messages sent to the application to a queue. By doing that , messages will be available to be picked by all the copies of the application that are running, do they can forward them to the clients that they are serving.</p>
<p>Here’s what you need to do:</p>
<ol class="arabic simple">
<li>Enhance the application to write the broadcast messages to a topic called “broadcast”.</li>
<li>Implement a consumer that read the messages from the “broadcast” topic and broadcasts the message.</li>
</ol>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>